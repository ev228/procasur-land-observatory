/* ==========================================================================
   pdf.js â€” Direct PDF download using html2pdf.js
   Full detailed report is generated ONLY in the PDF.
   ========================================================================== */

const PDF = {
    generate(result) {
        const date = new Date(result.date || Date.now()).toLocaleDateString('es-ES', {
            year: 'numeric', month: 'long', day: 'numeric'
        });

        const projectsList = (result.projects || [])
            .map(p => `${p.proyecto} (${p.pais})`).join(', ');

        // Format bullets as list items
        let bulletsHtml = '';
        if (result.bullets) {
            const lines = result.bullets.split('\n').filter(l => l.trim());
            bulletsHtml = lines.map(l =>
                `<li>${l.replace(/^\*\s*/, '').trim()}</li>`
            ).join('');
        }

        // Format full report with section headers
        let reportHtml = '';
        if (result.fullReport) {
            reportHtml = result.fullReport
                .replace(/^(\d+)\.\s+(.+)$/gm, '<h3 style="font-size:14pt;color:#1a1a1a;margin-top:25px;border-bottom:1px solid #ddd;padding-bottom:5px;">$1. $2</h3>')
                .replace(/\n/g, '<br>');
        }

        // Split full report into sections for proper page breaks
        let sectionsHtml = '';
        if (result.fullReport) {
            const sections = result.fullReport.split(/(?=^\d+\.\s+)/m).filter(s => s.trim());
            sectionsHtml = sections.map(section => {
                const formatted = section
                    .replace(/^(\d+)\.\s+(.+)$/m, '<h3 style="font-size:14pt;color:#1a1a1a;margin-top:20px;border-bottom:1px solid #ddd;padding-bottom:5px;">$1. $2</h3>')
                    .replace(/\n/g, '<br>');
                return `<div class="pdf-section">${formatted}</div>`;
            }).join('');
        }

        // Build the HTML for the PDF
        const container = document.createElement('div');
        container.innerHTML = `
            <style>
                .pdf-section { page-break-inside: avoid; break-inside: avoid; margin-bottom: 12px; }
                .pdf-bullets { page-break-inside: avoid; break-inside: avoid; }
                .pdf-header { page-break-inside: avoid; break-inside: avoid; }
                h3 { page-break-after: avoid; break-after: avoid; }
                li { page-break-inside: avoid; break-inside: avoid; }
            </style>
            <div style="font-family:Inter,Helvetica,Arial,sans-serif;font-size:11pt;line-height:1.6;color:#333;max-width:750px;margin:0 auto;padding:30px;">
                <div class="pdf-header" style="text-align:center;border-bottom:2px solid #2078B4;padding-bottom:20px;margin-bottom:25px;">
                    <img src="/assets/procasur-logo.png" style="height:36px;margin-bottom:8px;" crossorigin="anonymous">
                    <h1 style="font-size:13pt;color:#1a1a1a;letter-spacing:2px;text-transform:uppercase;margin:8px 0 0 0;">Land Projects Observatory</h1>
                    <div style="font-size:10pt;color:#2078B4;font-style:italic;">Cross-Project Analytical Report</div>
                </div>

                <div class="pdf-header" style="font-size:15pt;color:#2078B4;text-align:center;margin:25px 0;font-weight:700;">
                    ${result.title || 'Analisis de Proyectos'}
                </div>
                <div style="text-align:center;font-size:9pt;color:#888;margin-bottom:8px;">${date}</div>
                <div style="text-align:center;font-size:9pt;color:#666;font-style:italic;margin-bottom:25px;">
                    Proyectos analizados: ${projectsList}
                </div>

                ${bulletsHtml ? `
                    <div class="pdf-bullets" style="background:#f0f7fd;border-left:4px solid #2078B4;padding:14px 18px;margin:18px 0 25px 0;border-radius:4px;">
                        <div style="font-weight:700;font-size:11pt;margin-bottom:8px;color:#1a1a1a;">Hallazgos Clave</div>
                        <ul style="margin:0;padding-left:18px;">${bulletsHtml}</ul>
                    </div>
                ` : ''}

                <div style="font-size:11pt;line-height:1.7;text-align:justify;">
                    ${sectionsHtml}
                </div>

                <div style="margin-top:35px;padding-top:12px;border-top:1px solid #2078B4;text-align:center;font-size:8pt;color:#888;">
                    Generated by PROCASUR Land Projects Observatory &middot; PROCASUR Corporation &middot; www.procasur.org
                </div>
            </div>
        `;

        // Use html2pdf.js for direct download
        const opt = {
            margin: [15, 12, 15, 12],
            filename: `PROCASUR_Analysis_${new Date().toISOString().slice(0, 10)}.pdf`,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        html2pdf().set(opt).from(container).save();
    }
};
