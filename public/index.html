<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROCASUR Land Projects Observatory</title>

    <!-- Styles -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- html2pdf for direct PDF download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<!-- Header -->
<div class="header">
    <img src="/assets/procasur-logo.png" alt="PROCASUR">
    <h1>Land Projects <span>Observatory</span></h1>
    <div style="margin-left:auto;">
        <select id="lang-selector" style="font-family:Inter,sans-serif;font-size:14px;font-weight:600;padding:6px 12px;border:1px solid #ddd;border-radius:4px;background:#fff;cursor:pointer;">
            <option value="es">ES Espanol</option>
            <option value="en">EN English</option>
        </select>
    </div>
</div>

<!-- Navigation -->
<div class="nav">
    <button class="nav-tab active" data-view="dashboard">Dashboard</button>
    <button class="nav-tab" data-view="map">Map Explorer</button>
    <button class="nav-tab" data-view="network">Network Analysis</button>
    <button class="nav-tab" data-view="reports">Reports</button>
</div>

<!-- Main Content -->
<div class="main">

    <!-- ============ DASHBOARD VIEW ============ -->
    <div id="view-dashboard" class="view active">
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-total">--</div>
                <div class="kpi-label">Total Proyectos</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-active">--</div>
                <div class="kpi-label">Proyectos Activos</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-countries">--</div>
                <div class="kpi-label">Paises</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-funding">--</div>
                <div class="kpi-label">Valor Total (USD)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-highland">--</div>
                <div class="kpi-label">Alta Intensidad Tierra</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Proyectos por Pais</h3>
                <canvas id="chart-countries"></canvas>
            </div>
            <div class="chart-card">
                <h3>Proyectos por Estado</h3>
                <canvas id="chart-status"></canvas>
            </div>
            <div class="chart-card">
                <h3>Componente Tierra</h3>
                <canvas id="chart-land"></canvas>
            </div>
            <div class="chart-card">
                <h3>Timeline de Financiamiento</h3>
                <canvas id="chart-timeline"></canvas>
            </div>
            <div class="chart-card full-width">
                <h3>Principales Sectores</h3>
                <canvas id="chart-sectors"></canvas>
            </div>
            <div class="chart-card full-width">
                <h3>Principales Cofinanciadores</h3>
                <canvas id="chart-cofin"></canvas>
            </div>
        </div>
    </div>

    <!-- ============ MAP VIEW ============ -->
    <div id="view-map" class="view">
        <div class="map-controls">
            <div class="filter-group">
                <label>Pais</label>
                <select id="filter-country"><option value="">Todos</option></select>
            </div>
            <div class="filter-group">
                <label>Estado</label>
                <select id="filter-status"><option value="">Todos</option></select>
            </div>
            <div class="filter-group">
                <label>Sector</label>
                <select id="filter-sector"><option value="">Todos</option></select>
            </div>
            <div class="filter-group">
                <label>Componente Tierra</label>
                <select id="filter-land"><option value="">Todos</option></select>
            </div>
            <div class="filter-group">
                <label>Periodo</label>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="range" id="filter-year-min" min="2000" max="2030" value="2000">
                    <span class="year-display" id="year-display">2000 - 2030</span>
                    <input type="range" id="filter-year-max" min="2000" max="2030" value="2030">
                </div>
            </div>
            <button class="btn btn-primary btn-small" id="btn-apply-filters">Aplicar</button>
            <button class="btn btn-secondary btn-small" id="btn-reset-filters">Reset</button>
        </div>

        <div style="position:relative;">
            <div id="map-container"></div>
            <div class="selection-counter" id="selection-counter" style="display:none;">
                Seleccionados: <strong id="selection-count">0</strong>
            </div>
        </div>

        <div class="map-actions">
            <button class="btn btn-secondary" id="btn-refresh-data">Actualizar Datos</button>
            <button class="btn btn-primary" id="btn-analyze" disabled>Analizar Conexiones</button>
            <button class="btn btn-secondary" id="btn-clear-selection" style="display:none;">Limpiar Seleccion</button>
        </div>
    </div>

    <!-- ============ NETWORK VIEW ============ -->
    <div id="view-network" class="view">
        <div class="network-header">
            <button class="btn btn-primary" id="btn-generate-network">Generar Analisis de Red</button>
            <div class="filter-group">
                <label>Filtrar por Intensidad</label>
                <select id="network-filter-land">
                    <option value="">Todos</option>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Baja">Baja</option>
                </select>
            </div>
            <div id="network-clusters-bar" style="display:none;flex:1;display:flex;flex-wrap:wrap;gap:4px;"></div>
        </div>

        <div class="network-container">
            <div class="network-graph" id="network-graph">
                <div class="empty-state" id="network-empty">
                    <h3>Red de Proyectos IFAD</h3>
                    <p>Haz clic en "Generar Analisis de Red" para que la IA analice las conexiones entre todos los proyectos del portfolio.</p>
                </div>
            </div>
            <div class="network-detail" id="network-detail">
                <h3>Detalle del Proyecto</h3>
                <div class="empty-state">
                    <p>Selecciona un nodo en el grafo para ver sus detalles y conexiones.</p>
                </div>
            </div>
        </div>

        <div class="network-legend" id="network-legend" style="display:none;">
            <div class="legend-group"><span class="legend-dot" style="background:var(--red)"></span> Alta (8-10)</div>
            <div class="legend-group"><span class="legend-dot" style="background:var(--amber)"></span> Media (4-7)</div>
            <div class="legend-group"><span class="legend-dot" style="background:var(--blue)"></span> Baja (1-3)</div>
            <div style="width:1px;background:#ddd;margin:0 8px;"></div>
            <div class="legend-group"><span class="legend-line" style="background:var(--blue)"></span> Tematico</div>
            <div class="legend-group"><span class="legend-line" style="background:var(--green)"></span> Geografico</div>
            <div class="legend-group"><span class="legend-line" style="background:var(--amber)"></span> Metodologico</div>
            <div class="legend-group"><span class="legend-line" style="background:var(--purple)"></span> Temporal</div>
            <div class="legend-group"><span class="legend-line" style="background:var(--red)"></span> Institucional</div>
        </div>
    </div>

    <!-- ============ REPORTS VIEW ============ -->
    <div id="view-reports" class="view">
        <h2 style="font-size:18px;margin-bottom:16px;">Historial de Reportes</h2>
        <div id="reports-list" class="reports-list">
            <div class="empty-state">
                <h3>Sin reportes</h3>
                <p>Los reportes generados desde el Map Explorer o Network Analysis apareceran aqui.</p>
            </div>
        </div>
    </div>

</div>

<!-- Analysis Modal -->
<div class="modal-overlay" id="analysis-modal">
    <div class="modal">
        <div class="modal-header">
            <img src="/assets/procasur-logo.png" alt="PROCASUR">
            <h2>Land Projects Observatory</h2>
            <div class="subtitle">Cross-Project Analytical Report</div>
        </div>
        <div class="modal-body" id="analysis-body">
            <div class="loading">
                <div class="spinner"></div>
                <div class="loading-text">Analizando conexiones entre proyectos...</div>
            </div>
        </div>
        <div class="modal-footer" id="analysis-footer" style="display:none;">
            <button class="btn btn-primary" id="btn-download-pdf">Descargar PDF</button>
            <button class="btn btn-secondary" id="btn-close-modal">Cerrar</button>
        </div>
    </div>
</div>

<!-- JavaScript modules -->
<script src="/js/app.js"></script>
<script src="/js/dashboard.js"></script>
<script src="/js/map.js"></script>
<script src="/js/network.js"></script>
<script src="/js/analysis.js"></script>
<script src="/js/pdf.js"></script>
<script src="/js/reports.js"></script>

</body>
</html>
